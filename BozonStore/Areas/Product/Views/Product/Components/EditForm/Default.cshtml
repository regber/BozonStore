@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}
@model Product

<form id="productForm" asp-action="EditProduct" asp-controller="Product" asp-area="Product">

    <input name="ProductType" type="hidden" value="@ViewBag.ProductType" />
    <input name="Id" type="hidden" value="@Model.Id" />

    @Html.EditorForModel()
    @Html.EditorFor(m => m.Images)

    <input type="submit" value="Save" />
</form>


<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
<script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>

<script src="~/lib/handlebars.js/handlebars.js"></script>
<script src="~/js/handtemp.js"></script>


<script>
    $(document).ready(function () {

        SubmitLoadFileEvent();

        RenderLoadFileEvent();

        LoadImagesEditableProduct();

    });
</script>

<script>
    var MainImageName;
    const selectedClass = ["selectedImageContainer"];

    function SubmitLoadFileEvent() {
        $("#productForm").submit(function (event) {

            var allImagesContainers = $(document).find('.imageContainer');
            var mainImageFileName = "";

            allImagesContainers.each(function (idx) {

                if ($(this).hasClass(selectedClass)) {
                    mainImageFileName = $(this).find(".imagePreview").first().attr("filename");
                }
            });

            var formData = new FormData();

            $.each(imageFiles, function (idx, file) {
                if (mainImageFileName != file.name) {
                    formData.append('images[]', file);
                }
                else {
                    formData.append('mainImage', file);
                }
            });


            $.ajax({
                type: "POST",
                url: "UploadFile",
                data: formData,
                enctype: "multipart/form-data",
                contentType: false,
                processData: false,
                async: false
            });

            return true;
        });
    }
    function RenderLoadFileEvent() {
        $("#imagesFileInput").change(function () {

            $("#previewImages").empty();

            imageFiles = $('#imagesFileInput').prop('files');

            $.each(imageFiles, function (idx, file) {

                if (file) {
                    let reader = new FileReader();
                    reader.onload = function (event) {

                        if (file.name == MainImageName) {
                            CreateFromTemplate("#previewImages", "#imgTemplate", { filename: file.name, src: event.target.result, selected: selectedClass });
                        }
                        else {
                            CreateFromTemplate("#previewImages", "#imgTemplate", { filename: file.name, src: event.target.result });
                        }

                    }
                    reader.readAsDataURL(file);
                }
            });
        });
    }
    function LoadImagesEditableProduct() {
        var id =@Html.Raw(Model.Id);
        var images = @Html.Raw(@JsonConvert.SerializeObject(Model.Images));


        $.each(images, function (idx, img) {
            if (img.MainImage) {
                MainImageName = img.Name;
            }
        });

        const dt = new DataTransfer();

        document.querySelector('#imagesFileInput').files = dt.files;

        $.each(images, function (idx, img) {

            fetch("@Url.Action("GetProposalImage","Common", new {area="" })" + "?prodId=" + id +"&imageName=" + img.Name)
                .then(response => response.blob())
                .then(blobFile => new File([blobFile], img.Name, { type: "image/*" }))
                .then(file => {

                    dt.items.add(file);

                    if (dt.items.length == images.length) {
                        $("#imagesFileInput").trigger("change");
                    }
                });
        });
    }

    $(document).on('click', '.imageContainer', function () {
        var thisImageContainer = $(this);

        thisImageContainer.addClass(selectedClass);

        var allImagesContainers = $(document).find('.imageContainer');

        allImagesContainers.each(function () {
            if (thisImageContainer.find(".imagePreview").first().attr("filename") != $(this).find(".imagePreview").first().attr("filename")) {
                $(this).removeClass(selectedClass);
            }
        });
    });

</script>

<script type="text/x-handlebars-template" id="imgTemplate">
    <div class="imageContainer {{selected}}">

        <img class="imagePreview" height="100" src="{{src}}" filename="{{filename}}">
        <span>{{filename}}</span>

    </div>
</script>